<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login - Civic Events</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body class="bg-gray-100 min-h-screen flex flex-col justify-center items-center">

    <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-md">
        <div class="text-center mb-6">
            <i class="fas fa-city text-blue-600 text-4xl mb-2"></i>
            <h2 class="text-3xl font-extrabold text-gray-800">Civic Events Portal</h2>
        </div>
        
        <form id="login-form" class="space-y-6">
            <div>
                <label for="email" class="block text-sm font-medium text-gray-700">Email</label>
                <input type="email" id="email" required class="w-full mt-1 p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500">
            </div>
            <div>
                <label for="password" class="block text-sm font-medium text-gray-700">Password</label>
                <input type="password" id="password" required class="w-full mt-1 p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500">
            </div>
            <button id="login-btn" type="submit" class="w-full bg-blue-600 text-white p-3 rounded-lg hover:bg-blue-700 transition font-semibold shadow-lg">
                <i class="fas fa-sign-in-alt mr-2"></i> Sign In
            </button>
        </form>

        <p class="mt-6 text-center text-sm text-gray-600">
            Don't have an account? <a href="signup.html" class="text-blue-600 hover:underline font-medium">Sign up here</a>
        </p>
    </div>

    <script src="assets/js/api.js"></script>
    <script src="assets/js/auth.js"></script>
    <script src="assets/js/ui.js"></script>

    <script>
        $(document).ready(function() {
            // 1. If already logged in, redirect immediately
            if (Auth.isAuthenticated()) {
                if (Auth.isAdmin()) {
                    window.location.href = 'dashboard.html';
                } else {
                    window.location.href = 'events.html';
                }
            }

            // 2. Handle Login Submission
            $('#login-form').submit(async function(e) {
                e.preventDefault();
                const btn = $('button[type="submit"]'); 
                
                const originalText = btn.text();
                btn.prop('disabled', true).text('Authenticating...');

                const email = $('#email').val();
                const password = $('#password').val();

                try {
                    const response = await Api.post("/api/auth/login", { 
                        email: email, 
                        password: password 
                    });

                    // üîç DEBUGGING: Look at this line in your Console!
                    console.log("üîç FULL LOGIN RESPONSE:", response);

                    // TEMPORARY FIX: Handle common response variations
                    // Check if the token is inside a 'data' object or at the top level
                    const token = response.token || (response.data && response.data.token);
                    const user = response.user || (response.data && response.data.user);

                    if (token && user) {
                        Auth.setSession(token, user);
                        
                        UI.showToast("Login Successful!", "success");
                        
                        setTimeout(() => {
                            if (user.role === 'admin') {
                                window.location.href = 'dashboard.html';
                            } else {
                                window.location.href = 'events.html';
                            }
                        }, 1000);
                    } else {
                        // If we still fail, this error will show
                        console.error("‚ùå Missing Data. Token:", token, "User:", user);
                        throw new Error("Invalid response structure from server");
                    }

                } catch (error) {
                    console.error("Login Error:", error);
                    const msg = error.responseJSON?.message || "Login failed. Please check credentials.";
                    UI.showToast(msg, 'error');
                } finally {
                    btn.prop('disabled', false).text(originalText);
                }
            });
        });
    </script>
</body>
</html>